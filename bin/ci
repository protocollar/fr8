#!/usr/bin/env bash
set -euo pipefail

cd "$(git rev-parse --show-toplevel)"

pass=0
fail=0
failed_steps=()

step() {
  printf "\n\033[1;34m==> %s\033[0m\n" "$1"
}

ok() {
  printf "\033[1;32m    ✓ %s\033[0m\n" "$1"
  ((pass++)) || true
}

err() {
  printf "\033[1;31m    ✗ %s\033[0m\n" "$1"
  ((fail++)) || true
  failed_steps+=("$1")
}

# Build
step "Build"
if go build ./...; then
  ok "go build ./..."
else
  err "go build ./..."
fi

# Vet
step "Vet"
if go vet ./...; then
  ok "go vet ./..."
else
  err "go vet ./..."
fi

# Test
step "Test"
if go test -race -count=1 ./...; then
  ok "go test -race -count=1 ./..."
else
  err "go test -race -count=1 ./..."
fi

# Lint
step "Lint"
if command -v golangci-lint &>/dev/null; then
  if golangci-lint run; then
    ok "golangci-lint run"
  else
    err "golangci-lint run"
  fi
else
  printf "    \033[1;33m⚠ golangci-lint not installed — skipping\033[0m\n"
fi

# Tidy
step "Tidy"
go mod tidy
if git diff --exit-code go.mod go.sum &>/dev/null; then
  ok "go mod tidy (no diff)"
else
  err "go mod tidy produced changes"
fi

# Summary
printf "\n\033[1;34m==> Summary\033[0m\n"
printf "    %d passed, %d failed\n" "$pass" "$fail"
if ((fail > 0)); then
  printf "\n\033[1;31m    Failed:\033[0m\n"
  for s in "${failed_steps[@]}"; do
    printf "      ✗ %s\n" "$s"
  done
  exit 1
else
  printf "\n\033[1;32m    All checks passed.\033[0m\n"
fi
